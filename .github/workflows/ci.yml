name: CI Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  BUILD_TYPE: Release

jobs:
  build-ubuntu:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            libboost-all-dev \
            libevent-dev \
            libssl-dev \
            libdb++-dev \
            libminiupnpc-dev \
            libzmq3-dev \
            libqt5gui5 \
            libqt5core5a \
            libqt5dbus5 \
            qttools5-dev \
            qttools5-dev-tools \
            libqrencode-dev \
            libprotobuf-dev \
            protobuf-compiler \
            librsvg2-bin \
            help2man

      - name: Configure
        run: |
          mkdir build && cd build
          cmake .. -G Ninja -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

      - name: Build
        run: cmake --build build -j$(nproc)

      - name: Run tests
        run: cd build && ctest --output-on-failure

  build-macos-14:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install cmake ninja boost libevent openssl@3 berkeley-db \
            miniupnpc zeromq qt@5 qrencode protobuf librsvg help2man

      - name: Configure
        run: |
          mkdir build && cd build
          cmake .. -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3) \
            -DQt5_DIR=$(brew --prefix qt@5)/lib/cmake/Qt5 \
            -DBerkeleyDB_ROOT=$(brew --prefix berkeley-db)

      - name: Build
        run: cmake --build build -j$(sysctl -n hw.ncpu)

  build-macos-15:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install cmake ninja boost libevent openssl@3 berkeley-db \
            miniupnpc zeromq qt@5 qrencode protobuf librsvg help2man

      - name: Configure
        run: |
          mkdir build && cd build
          cmake .. -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3) \
            -DQt5_DIR=$(brew --prefix qt@5)/lib/cmake/Qt5 \
            -DBerkeleyDB_ROOT=$(brew --prefix berkeley-db)

      - name: Build
        run: cmake --build build -j$(sysctl -n hw.ncpu)

  build-macos-26:
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install cmake ninja boost libevent openssl@3 berkeley-db \
            miniupnpc zeromq qt@5 qrencode protobuf librsvg help2man

      - name: Configure
        run: |
          mkdir build && cd build
          cmake .. -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3) \
            -DQt5_DIR=$(brew --prefix qt@5)/lib/cmake/Qt5 \
            -DBerkeleyDB_ROOT=$(brew --prefix berkeley-db)

      - name: Build
        run: cmake --build build -j$(sysctl -n hw.ncpu)

  build-windows:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4

      # NOTE: Wallet disabled on Windows because BerkeleyDB 4.8.30 is incompatible
      # with VS2022's modern C++ headers (macro conflicts in clib_port.h with <stdint.h>).
      # Wallet is fully supported on Mac and Linux.

      - name: Clear any cached BerkeleyDB
        shell: cmd
        run: if exist C:\bdb rmdir /s /q C:\bdb

      - name: Install vcpkg dependencies
        run: |
          vcpkg install boost-filesystem:x64-windows boost-system:x64-windows `
            boost-thread:x64-windows boost-test:x64-windows libevent:x64-windows `
            openssl:x64-windows zeromq:x64-windows miniupnpc:x64-windows `
            qt5-base:x64-windows qt5-tools:x64-windows

      - name: Find Windows SDK
        id: winsdk
        shell: pwsh
        run: |
          $sdkPath = "C:/Program Files (x86)/Windows Kits/10"
          # Filter to only version folders (10.0.xxxxx.x format)
          $sdkVersion = (Get-ChildItem "$sdkPath/Include" | Where-Object { $_.Name -match '^\d+\.\d+\.\d+' } | Sort-Object Name -Descending | Select-Object -First 1).Name
          echo "SDK_VERSION=$sdkVersion" >> $env:GITHUB_OUTPUT
          echo "Found Windows SDK version: $sdkVersion"

      - name: Configure
        shell: pwsh
        run: |
          $sdkVersion = "${{ steps.winsdk.outputs.SDK_VERSION }}"
          $sdkInclude = "C:/Program Files (x86)/Windows Kits/10/Include/$sdkVersion/um"
          $sdkLib = "C:/Program Files (x86)/Windows Kits/10/Lib/$sdkVersion/um/x64"
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake `
            -DVCPKG_TARGET_TRIPLET=x64-windows `
            -DCMAKE_FIND_PACKAGE_PREFER_CONFIG=ON `
            -DCMAKE_PREFIX_PATH=C:/vcpkg/installed/x64-windows `
            -DCMAKE_LIBRARY_PATH="$sdkLib" `
            -DCMAKE_INCLUDE_PATH="$sdkInclude" `
            -DBUILD_RADIANT_WALLET=OFF `
            -DBUILD_RADIANT_ZMQ=OFF `
            -DQt5_DIR=C:/vcpkg/installed/x64-windows/share/cmake/Qt5 `
            -DSHLWAPI_INCLUDE_DIR="$sdkInclude" `
            -DSHLWAPI_shlwapi_LIBRARY="$sdkLib/shlwapi.lib" `
            -DIPHLPAPI_LIBRARY="$sdkLib/iphlpapi.lib" `
            -DWS2_32_LIBRARY="$sdkLib/ws2_32.lib"

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }}
