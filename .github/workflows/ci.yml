name: CI Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  BUILD_TYPE: Release

jobs:
  build-ubuntu:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            libboost-all-dev \
            libevent-dev \
            libssl-dev \
            libdb++-dev \
            libminiupnpc-dev \
            libzmq3-dev \
            libqt5gui5 \
            libqt5core5a \
            libqt5dbus5 \
            qttools5-dev \
            qttools5-dev-tools \
            libqrencode-dev \
            libprotobuf-dev \
            protobuf-compiler \
            librsvg2-bin \
            help2man

      - name: Configure
        run: |
          mkdir build && cd build
          cmake .. -G Ninja -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

      - name: Build
        run: cmake --build build -j$(nproc)

      - name: Run tests
        run: cd build && ctest --output-on-failure

  build-macos-14:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install cmake ninja boost libevent openssl@3 berkeley-db \
            miniupnpc zeromq qt@5 qrencode protobuf librsvg help2man

      - name: Configure
        run: |
          mkdir build && cd build
          cmake .. -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3) \
            -DQt5_DIR=$(brew --prefix qt@5)/lib/cmake/Qt5 \
            -DBerkeleyDB_ROOT=$(brew --prefix berkeley-db)

      - name: Build
        run: cmake --build build -j$(sysctl -n hw.ncpu)

  build-macos-15:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install cmake ninja boost libevent openssl@3 berkeley-db \
            miniupnpc zeromq qt@5 qrencode protobuf librsvg help2man

      - name: Configure
        run: |
          mkdir build && cd build
          cmake .. -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3) \
            -DQt5_DIR=$(brew --prefix qt@5)/lib/cmake/Qt5 \
            -DBerkeleyDB_ROOT=$(brew --prefix berkeley-db)

      - name: Build
        run: cmake --build build -j$(sysctl -n hw.ncpu)

  build-macos-26:
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install cmake ninja boost libevent openssl@3 berkeley-db \
            miniupnpc zeromq qt@5 qrencode protobuf librsvg help2man

      - name: Configure
        run: |
          mkdir build && cd build
          cmake .. -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3) \
            -DQt5_DIR=$(brew --prefix qt@5)/lib/cmake/Qt5 \
            -DBerkeleyDB_ROOT=$(brew --prefix berkeley-db)

      - name: Build
        run: cmake --build build -j$(sysctl -n hw.ncpu)

  build-windows:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4

      - name: Set up MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Cache BerkeleyDB
        id: cache-bdb
        uses: actions/cache@v4
        with:
          path: C:/bdb
          key: bdb-4.8.30-msvc-v1

      - name: Download and Build BerkeleyDB
        if: steps.cache-bdb.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $bdbVersion = "4.8.30"
          $bdbUrl = "https://download.oracle.com/berkeley-db/db-${bdbVersion}.tar.gz"
          $bdbDir = "C:\bdb"
          $srcDir = "$env:GITHUB_WORKSPACE\db-${bdbVersion}"
          $buildDir = "$srcDir\build_windows"
          
          # Download and extract
          Write-Host "Downloading BerkeleyDB ${bdbVersion}..."
          Invoke-WebRequest -Uri $bdbUrl -OutFile "db-${bdbVersion}.tar.gz"
          tar -xzf "db-${bdbVersion}.tar.gz"
          
          # Verify build_windows directory exists
          $buildDir = "$srcDir\build_windows"
          if (!(Test-Path $buildDir)) {
            Write-Error "build_windows directory not found"
            Get-ChildItem $srcDir -Directory | ForEach-Object { Write-Host "  DIR: $($_.Name)" }
            exit 1
          }
          
          # List all solution files for debugging
          Write-Host "Available solution files in build_windows:"
          Get-ChildItem -Path $buildDir -Filter "*.sln" | ForEach-Object { Write-Host "  $($_.Name)" }
          
          # Find the native C++ solution (Berkeley_DB*.sln, not BDB_dotNet)
          $slnFile = Get-ChildItem -Path $buildDir -Filter "Berkeley_DB*.sln" | Select-Object -First 1
          if (!$slnFile) {
            Write-Error "No Berkeley_DB*.sln file found in build_windows"
            exit 1
          }
          Write-Host "Using solution: $($slnFile.FullName)"
          
          # Change to build directory
          Push-Location $buildDir
          $slnName = $slnFile.Name
          
          # Build db project
          Write-Host "Building db library..."
          msbuild $slnName `
            /p:Configuration=Release `
            /p:Platform=x64 `
            /p:PlatformToolset=v143 `
            /p:WindowsTargetPlatformVersion=10.0 `
            /t:db `
            /m
          
          # Build db_cxx project  
          Write-Host "Building db_cxx library..."
          msbuild $slnName `
            /p:Configuration=Release `
            /p:Platform=x64 `
            /p:PlatformToolset=v143 `
            /p:WindowsTargetPlatformVersion=10.0 `
            /t:db_cxx `
            /m
          
          Pop-Location
          
          # Create install directory structure
          New-Item -ItemType Directory -Force -Path "$bdbDir\include"
          New-Item -ItemType Directory -Force -Path "$bdbDir\lib"
          
          # Copy headers
          Copy-Item "$buildDir\db.h" "$bdbDir\include\"
          Copy-Item "$buildDir\db_cxx.h" "$bdbDir\include\"
          
          # Find and copy libraries (check both possible output locations)
          $libPath = "$buildDir\x64\Release"
          if (!(Test-Path "$libPath\libdb48.lib")) {
            $libPath = "$buildDir\Win32\Release"
          }
          if (!(Test-Path "$libPath\libdb48.lib")) {
            Write-Host "Searching for built libraries..."
            Get-ChildItem -Recurse $buildDir -Filter "*.lib" | ForEach-Object { Write-Host $_.FullName }
            Write-Error "Could not find libdb48.lib"
            exit 1
          }
          
          Copy-Item "$libPath\libdb48.lib" "$bdbDir\lib\"
          Copy-Item "$libPath\libdb_cxx48.lib" "$bdbDir\lib\"
          Copy-Item "$libPath\*.dll" "$bdbDir\lib\" -ErrorAction SilentlyContinue
          
          Write-Host "BerkeleyDB built successfully at $bdbDir"
          Get-ChildItem -Recurse "$bdbDir"

      - name: Install vcpkg dependencies
        run: |
          vcpkg install boost-filesystem:x64-windows boost-system:x64-windows `
            boost-thread:x64-windows boost-test:x64-windows libevent:x64-windows `
            openssl:x64-windows zeromq:x64-windows miniupnpc:x64-windows `
            qt5-base:x64-windows qt5-tools:x64-windows

      - name: Find Windows SDK
        id: winsdk
        shell: pwsh
        run: |
          $sdkPath = "C:/Program Files (x86)/Windows Kits/10"
          $sdkVersion = (Get-ChildItem "$sdkPath/Include" | Sort-Object Name -Descending | Select-Object -First 1).Name
          echo "SDK_VERSION=$sdkVersion" >> $env:GITHUB_OUTPUT
          echo "Found Windows SDK version: $sdkVersion"

      - name: Configure
        shell: pwsh
        run: |
          $sdkVersion = "${{ steps.winsdk.outputs.SDK_VERSION }}"
          $sdkInclude = "C:/Program Files (x86)/Windows Kits/10/Include/$sdkVersion/um"
          $sdkLib = "C:/Program Files (x86)/Windows Kits/10/Lib/$sdkVersion/um/x64"
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake `
            -DVCPKG_TARGET_TRIPLET=x64-windows `
            -DCMAKE_FIND_PACKAGE_PREFER_CONFIG=ON `
            -DCMAKE_PREFIX_PATH=C:/vcpkg/installed/x64-windows `
            -DCMAKE_LIBRARY_PATH="$sdkLib" `
            -DCMAKE_INCLUDE_PATH="$sdkInclude" `
            -DBerkeleyDB_ROOT=C:/bdb `
            -DQt5_DIR=C:/vcpkg/installed/x64-windows/share/cmake/Qt5 `
            -DSHLWAPI_INCLUDE_DIR="$sdkInclude" `
            -DSHLWAPI_shlwapi_LIBRARY="$sdkLib/shlwapi.lib" `
            -DIPHLPAPI_LIBRARY="$sdkLib/iphlpapi.lib"

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }}
